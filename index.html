<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skylite Video Player</title>

    <!-- Video.js Library and Styles -->
    <link href="https://vjs.zencdn.net/7.17.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/7.17.0/video.min.js" defer></script>

    <!-- Video.js Quality Levels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-quality-levels@2.1.0/dist/videojs-contrib-quality-levels.min.js" defer></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
    .time-display-container {
        font-size: 14px !important;
        white-space: nowrap !important;
        display: flex !important;
        gap: 1px !important;
        margin-top: 1% !important;
        margin-left: 0.5em !important;
        align-items: center !important;
        /* display: none !important; */
        /* display: inline-block !important; */
        top: -3.7em !important;
        position: relative;
    }


    .vjs-subs-caps-button.vjs-menu-button.vjs-menu-button-popup.vjs-control.vjs-button {
        left: 4.8rem !important;
        position: absolute;
    }

    .video-js .vjs-play-progress:before {
        font-size: 2em;
        position: absolute;
        right: -0.5em;
       /* top: 0 !important; */
        z-index: 1;
        /* background: #2196f3 !important; */
    }

    .vjs-slider-horizontal .vjs-volume-level:before {
        top: 0 !important;
        right: -0.5em;
    }


    .video-js .vjs-time-control {
        flex: none;
        font-size: 1.2em !important;
        line-height: 3em;
        min-width: 0.7em !important;
        width: auto;
        padding-left: 0em !important;
        padding-right: 0.3em !important;
        display: none !important;
        top: 1.5em;
    }

    button.vjs-resolution-button.vjs-control.vjs-button {
        display: none !important;
    }


    @supports (display: grid) {
        .vjs-text-track-settings .vjs-modal-dialog-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr;
            padding: 20px 24px 0px 24px;
            background: #000 !important;
            z-index: 11;
        }
    }

    .vjs-text-track-settings legend {
        color: #fff;
        margin: 0 0 5px 0;
        font-size: 14px;
        font-weight: 600 !important;
    }

    button.vjs-close-button.vjs-control.vjs-button {
        color: #fff !important;
    }

    button.vjs-default-button {
        background: #fff !important;
        color: #000 !important;
        padding: 1px 10px !important;
    }

    .vjs-time-control.vjs-time-divider {
        position: relative !important;
        top: 1em !important;
    }

    button.vjs-done-button {
        background: #fff !important;
        color: #000 !important;
        padding: 1px 10px !important;
    }

    .vjs-text-track-settings fieldset span > select {
        max-width: 7.3em;
        border: none;
        background: #ccc;
        padding: 1px 10px;
        align-items: center;
        display: flex;
        font-size: 12px;
        color: #000;
        border-radius: 2px;
    }

    .vjs-track-setting > select {
        margin-right: 1em;
        margin-bottom: 0.5em;
        max-width: 7.3em;
        border: none;
        background: #ccc !important;
        padding: 1px 10px;
        align-items: center;
        display: flex;
        font-size: 12px;
        color: #000 !important;
        border-radius: 2px;
    }

    .vjs-modal-dialog.vjs-text-track-settings {
        background-color: #2B333F;
        background-color: rgba(43, 51, 63, 0.75);
        color: #fff;
        height: 100% !important;
        background: #000 !important;
        z-index: 20;
    }


    .vjs-play-progress.vjs-slider-bar {
        background: #2196f3 !important;
    }

    .vjs-slider-horizontal .vjs-volume-level {
        height: 0.3em;
        background: #2196f3 !important;
    }

    .vjs-menu-button-popup .vjs-menu .vjs-menu-content {
        background-color: #2B333F;
        background-color: rgba(43, 51, 63, 0.7);
        position: absolute;
        width: 100%;
        bottom: 1.6em !important;
        max-height: 15em;
        background: #000 !important;
        padding: 5px !important;
        padding-bottom: 10px !important;
        border-radius: 10px !important;
        padding-top: 10px !important;
    }

    .vjs-menu .vjs-menu-content > * {
        box-sizing: border-box;
        margin-top: 5px !important;
        font-size: 12px !important;
    }





    .vjs-icon-play:before, .video-js .vjs-play-control .vjs-icon-placeholder:before, .video-js .vjs-big-play-button .vjs-icon-placeholder:before {
        content: "\f101";
        /* color: #2196f3 !important; */
        /* border: 2px solid #fff; */
        /* border-radius: 50%; */
        /* height: auto; */
        /* width: fit-content; */
        font-size: 1.7rem;
        justify-content: center;
        display: grid;
        display: flex;
        align-items: center;
        /* background: #2196f3; */
        border-radius: 100px;
        height: 3rem !important;
        width: 3rem !important;
        /* margin-left: 10px; */
        /* margin-top: 1px !important; */
        font-size: 5em !important;
    }

    button.vjs-mute-control.vjs-control.vjs-button.vjs-vol-3 {
        left: 2em !important;
    }

    button.vjs-subtitle-button.vjs-control.vjs-button {
        /* font-size: 1.5em; */
        font-size: 1.5rem !important;
        /* line-height: 1.67; */
        align-items: center !important;
        display: flex !important;
        right: -2em !important;
    }

    .vjs-button > .vjs-icon-placeholder:before {
        font-size: 2rem !important;
        line-height: 1.67;
        align-items: center !important;
        display: flex !important;
    }



    .video-js .vjs-volume-panel .vjs-volume-control.vjs-volume-horizontal {
        transition: visibility 1s, opacity 1s, height 1s 1s, width 1s, left 1s 1s, top 1s 1s;
        /* background: #000 !important; */
        top: 1em !important;
    }


    /* Ensure the progress control spans full width and appears above controls */
    .video-js .vjs-progress-control {
        cursor: pointer;
        flex: auto;
        display: flex;
        align-items: center;
        min-width: 4em;
        touch-action: none;
        position: absolute !important; /* Change position to absolute */
        top: -5px !important; /* Adjust height to place it above the controls */
        left: 0 !important; /* Start from the very left */
        width: 100% !important; /* Occupy the full width */
        z-index: 0 !important; /* Ensure it appears above control elements */
        height: 8px !important; /* Add some height for better visibility */
        background: transparent; /* Ensure no background blocks visuals */
    }

    .video-js .vjs-volume-panel {
        display: flex;
        left: 10em !important;
        position: absolute !important;
    }

    @media (min-width: 320px) and (max-width: 1024px) { 
        .video-js .vjs-volume-panel {
            display: flex;
            left: 10em !important;
            position: absolute !important;
            display: none !important;
        }

    }

    /* Style for the play progress bar */
    .video-js .vjs-progress-control .vjs-play-progress {
        background: linear-gradient(90deg, #2196f3, #21cbf3) !important;
        height: 100% !important; /* Match the height of the progress container */
        border-radius: 4px; /* Rounded corners for a polished look */
    }

    /* Ensure the control bar remains behind the progress bar */
    .video-js .vjs-control {
        position: relative;
        text-align: center;
        margin: 0;
        padding: 0;
        height: 100%;
        width: 4em;
        flex: none;
        z-index: 5; /* Lower z-index to keep it under progress bar */
    }

    /* Optional: Hover effect for progress bar interactivity */
    .video-js .vjs-progress-control:hover {
        height: 10px; /* Slight increase on hover for better interactivity */
    }

    /* Prevent clipping of elements */
    .video-js {
        overflow: visible !important; /* Ensures progress bar doesn't get clipped */
    }




    /* Ensure fullscreen and picture-in-picture buttons are aligned to the right */
    .video-js .vjs-fullscreen-control {
        margin-left: auto !important;
        right: -4.5em !important;
    }

    /* Hide the picture-in-picture button completely */
    .video-js .vjs-picture-in-picture-control {
        display: none !important; /* Remove the button from display */
    }
    /* Center the play/pause button in the control bar */
    /* Ensure the play/pause button is centered */
    .video-js .vjs-play-control {
        position: absolute !important; /* Take the button out of normal flow */
        left: 50% !important; /* Center horizontally within the control bar */
        transform: translateX(-50%) !important; /* Adjust for the button's own width */
    }

    /* Maintain the default layout for other controls */
    .video-js .vjs-control-bar {
        display: flex !important;
        align-items: center !important;
        height: 3rem !important;
        background: transparent !important;
    }



    .vjs-audio-button.vjs-menu-button.vjs-menu-button-popup.vjs-control.vjs-button {
        display: none !important;
    }




    .video-js .vjs-big-play-button {
        display: none !important;
    }

    .vjs-current-time.vjs-time-control.vjs-control {
        display: none !important;
    }

    .vjs-duration.vjs-time-control.vjs-control {
        display: none !important;
    }

    .vjs-descriptions-button.vjs-menu-button.vjs-menu-button-popup.vjs-control.vjs-button.vjs-hidden {
        display: none !important;
    }

    button.vjs-seek-to-live-control.vjs-control {
        display: none !important;
    }

    .vjs-volume-panel.vjs-control.vjs-volume-panel-horizontal {
        display: none !important;
    }

    .vjs-chapters-button.vjs-menu-button.vjs-menu-button-popup.vjs-control.vjs-button.vjs-hidden {
        display: none !important;
        left: -1.5em !important;
    }

    .vjs-time-separator {
        padding-left: 0.2em !important;
        padding-right: 0.2em !important;
    }


    .vjs-playback-rate > .vjs-menu-button, .vjs-playback-rate .vjs-playback-rate-value {
        position: absolute;
        top: 0.3em !important;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .vjs-playback-rate.vjs-menu-button.vjs-menu-button-popup.vjs-control.vjs-button {
        font-size: 1.3em !important;
        /*left: -1.5em !important;*/
    }
</style>
</head>
<body>
    <!-- Video Container -->
    <video id="skylite-video" class="video-js vjs-default-skin" controls preload="auto" width="100%" height="500px"></video>

    <script>

        function skyliteVideoPlayer(playerId, videoSrc) {
            var player = videojs(playerId, {
                controls: true,
                autoplay: false,
                preload: 'auto',
                fluid: true,
                playbackRates: [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2],
                controlBar: {
                    volumePanel: false,
                    fullscreenToggle: true,
                    remainingTimeDisplay: false,
                    playbackRateMenuButton: true // Enable the button

                },
            });

            // Prevent default right-click context menu
            player.on('contextmenu', function(event) {
                event.preventDefault();
            });

            // Set the correct MIME type for MP4 videos
            player.src({
                src: videoSrc,               // Use the MP4 source URL
                type: 'video/mp4'            // Set the MIME type for regular MP4 videos
            });

            // Add custom remaining time and total time display when the player is ready
            // Add custom remaining time and total time display when the player is ready
            player.ready(function () {
                // Create a container for remaining time and total time
                var timeDisplayContainer = player.controlBar.addChild('Component', {}, 0);
                timeDisplayContainer.addClass('time-display-container');

                // Add remaining time display first
                var remainingTimeDisplay = timeDisplayContainer.addChild('Component', {}, 0);
                remainingTimeDisplay.addClass('vjs-remaining-time');

                // Add separator between remaining time and total time
                var separator = timeDisplayContainer.addChild('Component', {}, 1);
                separator.addClass('vjs-time-separator');
                separator.el().innerHTML = ' / ';

                // Add total duration display after the remaining time
                var totalTimeDisplay = timeDisplayContainer.addChild('Component', {}, 2);
                totalTimeDisplay.addClass('vjs-duration-display');

                // Update remaining time and total time dynamically
                // Update timeupdate listener
                player.on('timeupdate', function () {
                    var remainingTime = player.remainingTime();
                    var totalTime = player.duration();
                    
                    // Check if remainingTime and totalTime are valid numbers
                    if (!isNaN(remainingTime) && !isNaN(totalTime)) {
                        remainingTimeDisplay.el().innerHTML = '' + formatTime(remainingTime);
                        totalTimeDisplay.el().innerHTML = formatTime(totalTime);
                    }
                });
            });

            // Function to format time in hh:mm:ss format

            // Updated formatTime function
            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return "00:00";  // Handle invalid values gracefully
                var date = new Date(0);  // Initialize a date with time set to zero
                date.setSeconds(seconds);
                var timeString = date.toISOString().substr(11, 8);
                return timeString.startsWith('00:') ? timeString.substr(3) : timeString;
            }

            // Hide the menu pop-up but keep the button
            player.ready(function () {
                // Select the playback rate button
                var playbackRateButton = player.controlBar.getChild('PlaybackRateMenuButton');

                if (playbackRateButton) {
                    // Remove the menu popup functionality
                    playbackRateButton.menu.dispose(); // Dispose of the menu
                    playbackRateButton.menu = null; // Clear reference to prevent default behavior
                }

                // Custom behavior for the button (optional)
                playbackRateButton.el().addEventListener('click', function () {
                    // Example: Cycle through playback rates manually
                    var currentRate = player.playbackRate();
                    var rates = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2];
                    var nextRateIndex = (rates.indexOf(currentRate) + 1) % rates.length;
                    player.playbackRate(rates[nextRateIndex]);

                    // Display the new rate (optional)
                    console.log('Playback rate set to:', rates[nextRateIndex]);
                });
            });


            // Create the subtitle button in the control bar
            var subtitleButton = document.createElement('button');
            subtitleButton.classList.add('vjs-subtitle-button', 'vjs-control', 'vjs-button');
            subtitleButton.innerHTML = '<i id="sub-title-icon" class="fa-regular fa-closed-captioning"></i>'; // Initial icon indicating subtitles are off
            player.controlBar.el().appendChild(subtitleButton);

            var subtitleTrackLoaded = false; // Flag to track if subtitles are loaded

            // Function to add subtitle tracks to the player
            function loadSubtitleTrack(label, srcLang, src) {
                if (!subtitleTrackLoaded) {
                    player.addRemoteTextTrack({
                        kind: 'subtitles',
                        label: label,
                        srclang: srcLang,
                        src: src,
                        default: true
                    }, false);
                    subtitleTrackLoaded = true; // Mark that subtitles are now loaded
                }
            }

            // Load subtitle tracks when the user clicks the subtitle button for the first time
            subtitleButton.addEventListener('click', function () {
                // Lazy load the subtitles on first click to improve initial load performance
                if (!subtitleTrackLoaded) {
                    loadSubtitleTrack('English', 'en', 'https://gist.githubusercontent.com/jimzimmerman/776cd9f344cf41691d732c5f13f8abf0/raw/fe6d9124e3e861b879ad711f925ee260acdf5f53/subtitles-en.vtt'); // Sample subtitle file
                }

                // Toggle subtitles on/off more efficiently
                var tracks = player.textTracks();
                for (var i = 0; i < tracks.length; i++) {
                    if (tracks[i].kind === 'subtitles') {
                        if (tracks[i].mode === 'showing') {
                            tracks[i].mode = 'disabled'; // Hide subtitles
                            subtitleButton.innerHTML = '<i class="fa-regular fa-closed-captioning"></i>'; // Update icon to indicate subtitles are off
                        } else {
                            tracks[i].mode = 'showing'; // Show subtitles
                            subtitleButton.innerHTML = '<i class="fa-solid fa-closed-captioning"></i>'; // Update icon to indicate subtitles are on
                        }
                    }
                }
            });

            // Variables to track touch positions
            // Variables to track touch positions
            let touchStartX = 0;
            let touchStartY = 0;
            let touchEndX = 0;
            let touchEndY = 0;
            const TAP_THRESHOLD = 10; // Threshold for detecting tap, adjust as needed
            const DOUBLE_TAP_DELAY = 300; // Maximum delay between taps for double-tap detection
            let lastTapTime = 0; // To store the time of the last tap
            let overlayTimeout; // To control how long the overlay stays visible

            // Declare controlBarTimeout variable to avoid conflicts
            var controlBarTimeout;

            // Function to show the control bar and elements
            function showControlBar() {
                player.controlBar.show();
                player.userActive(true); // Ensures controls are shown
            }

            // Function to update the play/pause icon based on video state
            function updatePlayPauseIcon() {
                if (player.paused()) {
                    player.controlBar.playToggle.controlText('Play');  // Show play icon
                } else {
                    player.controlBar.playToggle.controlText('Pause'); // Show pause icon
                }
            }

            // Function to show the forward/backward overlay message
            function showOverlayMessage(message) {
                // Get or create the overlay element
                let overlay = document.getElementById('video-overlay-message');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'video-overlay-message';
                    overlay.style.position = 'absolute';
                    overlay.style.top = '50%';
                    overlay.style.left = '50%';
                    overlay.style.transform = 'translate(-50%, -50%)';
                    overlay.style.color = 'white';
                    overlay.style.fontSize = '24px';
                    overlay.style.fontWeight = 'bold';
                    overlay.style.background = 'rgba(0, 0, 0, 0.5)';
                    overlay.style.padding = '10px 20px';
                    overlay.style.borderRadius = '5px';
                    overlay.style.zIndex = '1000';
                    overlay.style.pointerEvents = 'none'; // So it doesn't block any interaction
                    player.el().appendChild(overlay);
                }

                // Update the overlay message
                overlay.textContent = message;

                // Clear any previous timeout and set a new one to hide the overlay after 1 second
                clearTimeout(overlayTimeout);
                overlayTimeout = setTimeout(() => {
                    overlay.style.display = 'none';
                }, 1000);

                // Make sure the overlay is visible
                overlay.style.display = 'block';
            }

            // Add touchstart event listener to capture the initial touch position
            player.el().addEventListener('touchstart', function(event) {
                const touch = event.touches[0];
                touchStartX = touch.screenX;
                touchStartY = touch.screenY;

                // Show control bar when touch starts
                showControlBar();
            });
        ///////////////////////////////////////////////////////////////
            var progressBar = player.controlBar.progressControl.el();
            var progressFill = progressBar.querySelector('.vjs-play-progress');
            
            // Improved touch handling logic
            progressBar.addEventListener('touchstart', function (event) {
                event.preventDefault();
            });
            
            progressBar.addEventListener('touchmove', function (event) {
                event.preventDefault();
                if (event.touches && event.touches.length === 1) {
                    const touch = event.touches[0];
                    const rect = progressBar.getBoundingClientRect();
            
                    // Calculate progress percentage
                    const touchX = Math.max(0, Math.min(rect.width, touch.clientX - rect.left));
                    const progressPercent = touchX / rect.width;
            
                    // Update player's time and progress fill position
                    const newTime = progressPercent * player.duration();
                    player.currentTime(newTime);
            
                    // Update the visual progress immediately
                    requestAnimationFrame(() => {
                        progressFill.style.width = `${progressPercent * 100}%`;
                    });
                }
            });
            
            progressBar.addEventListener('touchend', function () {
                // Finalize interaction if needed
            });
        ////////////////////////////////////////////////////    
            // Add touchend event listener to detect if the movement qualifies as a double-tap
            player.el().addEventListener('touchend', function(event) {
                const touch = event.changedTouches[0];
                touchEndX = touch.screenX;
                touchEndY = touch.screenY;

                const deltaX = Math.abs(touchEndX - touchStartX);
                const deltaY = Math.abs(touchEndY - touchStartY);

                const targetElement = event.target;

                const ignoredSelectors = [
                    '.vjs-volume-panel',
                    '.vjs-resolution-button',
                    '.vjs-fullscreen-control',
                    '.vjs-picture-in-picture-control',
                    '.vjs-subtitle-button',
                    '.vjs-autoplay-switch',
                    '.vjs-control-bar',
                    '.vjs-play-control',
                    '.vjs-mute-control',
                    '.vjs-progress-control'
                ];

                const isIgnoredElement = ignoredSelectors.some(selector => targetElement.closest(selector));

                const currentTime = new Date().getTime();
                const timeSinceLastTap = currentTime - lastTapTime;

                if (!isIgnoredElement && deltaX < TAP_THRESHOLD && deltaY < TAP_THRESHOLD) {
                    if (timeSinceLastTap < DOUBLE_TAP_DELAY) {
                        // It's a double-tap
                        const playerWidth = player.el().clientWidth;
                        const tapPosition = touchEndX / playerWidth; // Normalize touch position to [0, 1]

                        if (tapPosition < 0.5) {
                            // Double-tap on the left side (backward)
                            player.currentTime(Math.max(0, player.currentTime() - 10)); // Backward 10 seconds
                            showOverlayMessage('-10s'); // Show backward overlay
                        } else {
                            // Double-tap on the right side (forward)
                            player.currentTime(Math.min(player.duration(), player.currentTime() + 10)); // Forward 10 seconds
                            showOverlayMessage('+10s'); // Show forward overlay
                        }
                    }
                    lastTapTime = currentTime;
                } else {
                    // If it's a swipe or unintentional touch, just show the control bar
                    showControlBar();
                }
            });

            // Update play/pause icon when the video state changes
            player.on('pause', updatePlayPauseIcon);
            player.on('play', updatePlayPauseIcon);

            // Ensure the control bar stays visible when there's any user interaction
            player.on('mousemove', showControlBar);
            player.on('touchmove', showControlBar);

            // Optionally, hide the control bar after a period of inactivity
            function resetControlBarTimeout() {
                clearTimeout(controlBarTimeout);
                controlBarTimeout = setTimeout(() => player.userActive(false), 30000); // Hide after 30 seconds of inactivity
            }
            player.on('useractive', resetControlBarTimeout);




            // Adding keyboard event listeners for play/pause, forward, and backward
            document.addEventListener('keydown', function(event) {
                if (event.target.tagName.toLowerCase() !== 'input' && event.target.tagName.toLowerCase() !== 'textarea') {
                    switch (event.key) {
                        case ' ':
                            event.preventDefault();
                            if (player.paused()) {
                                player.play();
                            } else {
                                player.pause();
                            }
                            break;
                        case 'ArrowRight':
                            event.preventDefault();
                            player.currentTime(player.currentTime() + 10); // Forward 10 seconds
                            break;
                        case 'ArrowLeft':
                            event.preventDefault();
                            player.currentTime(player.currentTime() - 10); // Backward 10 seconds
                            break;
                        case 'n':
                            event.preventDefault();
                            loadVideoByIndex(currentVideoIndex + 1); // Next video
                            break;
                        case 'p':
                            event.preventDefault();
                            loadVideoByIndex(currentVideoIndex - 1); // Previous video
                            break;
                    }
                }
            });


            return player;
        }

        document.addEventListener('DOMContentLoaded', function() {
            var videoList = [
                'https://bitdash-a.akamaihd.net/content/sintel/hls/playlist.m3u8',
                'https://mtoczko.github.io/hls-test-streams/test-vtt/playlist.m3u8',  // HLS with VTT Subtitles
                'https://mtoczko.github.io/hls-test-streams/test-gap/playlist.m3u8',  // HLS Stream with subtitle gap testing
                'https://playertest.longtailvideo.com/adaptive/oceans_aes/oceans_aes.m3u8',  // AES encrypted stream with subtitles
                'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8',
                'https://devstreaming-cdn.apple.com/videos/streaming/examples/img_bipbop_adv_example_ts/master.m3u8', // Video with built-in subtitles           
            ];

            skyliteVideoPlayer('skylite-video', videoList[0], videoList, 'https://example.com/adtag.m3u8');
        });
    </script>

</body>
</html>